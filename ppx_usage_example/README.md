# PPX Usage example

This shows how to build a OCaml project containing a library in [./lib/](./lib/) using Sedlex and Menhir and PPXs, a binary in [./bin/](./bin/) that uses the library and tests of the library in [./test/](./test/) using Buck 2.

- [Setup](#setup)
- [Buck 2 Targets](#buck-2-targets)
  - [Examples](#examples)
- [Buck 2 Files](#buck-2-files)

## Setup

All you need to do to be able to build this project, is to install a new Opam switch and the needed packages.

In this directory `ppx_usage_example`, run the following command to create the Opam switch and install the packages configured in the file [./third-party/dromedary.json](./third-party/dromedary.json):

Use the actual path to `dromedary.py` instead of just `dromedary.py` in the example.

```text
python3 dromedary.py -o third-party/BUCK third-party/dromedary.json
```

Then, the Opam switch's environment must be activated:

```text
opam switch ./third-party
eval $(opam env --switch=./third-party --set-switch)
```

Now all needed packages should be installed and set up, so you can build and run the executable:

```text
buck2 run //:bin
```

and the tests:

```text
buck2 run //:test
```

## Buck 2 Targets

- `buck2 clean` - deletes all generated files (in the directory `./buck-out/v2/`).
- `buck2 targets //...` - lists all available targets, including all Opam packages. The packages have a prefix of `root//third-party`.
- `buck2 build //...` - builds all targets.
- `buck2 run //:bin` - run the generated executable. This is an alias for `buck2 run //bin:ppx_usage_example`.
- `buck2 run //:test` - run the generated executable. This is an alias for `buck2 run //test:ppx_usage_example`.

### Examples

List only the targets of `ppx_usage_example`, without the Opam packages:

```text
> buck2 targets //lib: //bin: //test: //:
File changed: root//_build/_tests/KV7ZC8RR
File changed: root//_build/_tests/Interpreter Tests
File changed: root//_build/_tests/latest
8 additional file change events
Build ID: 1a90bd60-aa82-40cb-b9ce-0579c6af3cc3
Jobs completed: 4. Time elapsed: 0.0s.
root//:bin
root//:lib
root//:test
root//bin:ppx_usage_example
root//lib:ppx
root//lib:ppx_usage_example
root//lib:ppx_usage_example.mli
root//lib:ppx_usage_example__
root//test:ppx_usage_example
```

Run the generated executable:

```text
> buck2 run //:bin
File changed: root//README.md
Build ID: a3a39c17-7ce6-4f66-82cd-0ef911808269
Jobs completed: 3. Time elapsed: 0.0s.
BUILD SUCCEEDED
Some examples:
1 + 2 * 5 = 11
1.486 - 2.5 / 0.123 = -18.839203252
let a = 5 in a / 3 = 1
let a = 4.0 - 5.2 in let b = a * 0.123 in let c = 5.6 in a + b + c = 4.2524
```

Run the tests:

```text
> buck2 run //:test
File changed: root//README.md
Build ID: a530a4cd-8d04-4d22-ae29-24660f9f7131
Jobs completed: 3. Time elapsed: 0.0s.
BUILD SUCCEEDED
qcheck random seed: 452248485
Testing `Interpreter Tests'.
This run has ID `MEA9S8KL'.

  [OK]          Fixed terms and results          0   1 - 1 = 0.
  [OK]          Fixed terms and results          1   2.0 * 1.75 - 4.5 = -1.0.
  [OK]          Fixed terms and results          2   let a = 5.21 in a - 0.21 = 5.0.
  [OK]          Generated Terms                  0   n - m.
  [OK]          Generated Terms                  1   n + m.
  [OK]          Generated Terms                  2   n * m.
  [OK]          Generated Terms                  3   n / m.

Full test results in `./OCaml-Buck-2-Examples/ppx_usage_example/_build/_tests/Interpreter Tests'.
Test Successful in 0.007s. 7 tests run.
```

## Buck 2 Files

- [./.buckroot](./.buckroot) - this marks the directory as the root of the Buck 2 directories. In real examples you might want to put all your projects in subdirectories of the Buck 2 root directory. This is an empty file.
- [./.buckconfig](./.buckconfig) - Contains the configuration generated by `buck2 init --git`.
- [./toolchains/BUCK](./toolchains/BUCK) - The configuration of the toolchains to use. You always need C++ (`system_cxx_toolchain`) and  Python (`system_python_bootstrap_toolchain`). The OCaml tool chain is `system_ocaml_toolchain`.
- [./third-party/](./third-party/) - This directory contains all third party dependencies and their configuration, like Opam packages. In a bigger Buck 2 configuration you want to use one subdirectory for each language or for each project, e.g. `third-party/ocaml` for all OCaml project dependencies or `third-party/basic-example` for the dependencies of `ppx_usage_example`, if for example Opam package versions differ from project to project.
- [./third-party/dromedary.json](./third-party/dromedary.json) - This is the configuration of the Opam switch to create and the packages to install.
- [./third-party/BUCK](./third-party/BUCK) - The configuration of the Opam packages. Generated by the `ocaml-script` `dromedary.py`, and should not be edited manually.
- [./BUCK](./BUCK) - The main Buck 2 configuration file. Contains shorter aliases for the `bin` and `test` targets.
- [./bin/BUCK](./bin/BUCK) - The rules to build the binary.
- [./lib/BUCK](./lib/BUCK) - The rules to build the library.
- [./test/BUCK](./test/BUCK) - The rules to build the test.
- [./prelude/](./prelude/) - Contains all toolchains and rules for all supported languages of Buck 2. A Git submodule.
